<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistem Pelaporan dan Evaluasi | GASSTerus!</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>
  
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <style>
    :root{
      /* MRT Jakarta Corporate Colors */
      --mrt-blue: #005EB8;       
      --mrt-dark-blue: #004a94;  
      --mrt-green: #00A651;      
      --mrt-dark: #0f172a;       
      
      --bg-light: #f8fafc;
      --text-dark: #1e293b;
      --text-muted: #64748b;
      --card-bg: #ffffff;
      --border-color: #e2e8f0;
      --input-bg: #ffffff;
    }

    /* DARK MODE VARIABLES */
    body.dark-mode {
        --bg-light: #121212;
        --text-dark: #e2e8f0;
        --text-muted: #94a3b8;
        --card-bg: #1e1e1e;
        --border-color: #2d2d2d;
        --input-bg: #2d2d2d;
    }

    body { 
        background: var(--bg-light); 
        font-family: 'Plus Jakarta Sans', sans-serif; 
        color: var(--text-dark);
        margin: 0; padding: 0;
        overflow-x: hidden;
        transition: background 0.3s, color 0.3s;
    }

    /* DARK MODE SPECIFIC OVERRIDES */
    body.dark-mode .form-control, 
    body.dark-mode .form-select {
        background-color: var(--input-bg);
        border-color: var(--border-color);
        color: var(--text-dark);
    }
    body.dark-mode .form-control:focus {
        border-color: var(--mrt-blue);
        background-color: #333;
    }
    body.dark-mode .bg-light { background-color: #252525 !important; }
    body.dark-mode .table { color: var(--text-dark); }
    body.dark-mode .table-light { background-color: #2d2d2d; color: var(--text-dark); }
    body.dark-mode .editor-toolbar { background-color: #2d2d2d; border-color: #404040; }
    body.dark-mode .editor-btn { background-color: #333; border-color: #404040; color: #fff; }
    body.dark-mode .dropdown-content { background-color: #1e1e1e; border-color: #2d2d2d; }
    body.dark-mode .dropdown-content button { color: #fff; }
    body.dark-mode .dropdown-content button:hover { background-color: #333; }
    body.dark-mode .hero-title, body.dark-mode .menu-welcome { color: #60a5fa; } /* Lighter blue for dark mode */

    /* --- DISABLE SCROLL ON LANDING --- */
    body.landing-active { overflow: hidden; }

    /* --- NAVIGATION --- */
    .topbar {
      position: sticky; top: 0; z-index: 1000;
      background: var(--card-bg); /* Adaptive */
      border-bottom: 1px solid var(--border-color);
      display: none; 
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }
    .topbar.show { display: block; }
    
    .btn-nav { font-weight: 600; color: var(--text-muted); border-radius: 8px; padding: 8px 16px; border:none; background: transparent; transition:0.3s; text-decoration: none; display: inline-block; cursor: pointer; }
    .btn-nav:hover { color: var(--mrt-blue); background: rgba(0, 94, 184, 0.1); }
    .btn-nav.active { background: var(--mrt-blue); color: #fff; }

    /* Dropdown CSS */
    .nav-item-dropdown { position: relative; display: inline-block; }
    .dropdown-content {
        display: none; position: absolute; background-color: var(--card-bg);
        min-width: 180px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1; border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color);
        top: 100%; left: 0;
    }
    .dropdown-content button {
        color: var(--text-dark); padding: 12px 16px; text-decoration: none;
        display: block; width: 100%; text-align: left; border: none; background: none;
        font-size: 0.9rem; font-weight: 500; transition: 0.2s;
    }
    .dropdown-content button:hover { background-color: rgba(0, 94, 184, 0.1); color: var(--mrt-blue); }
    .nav-item-dropdown:hover .dropdown-content { display: block; }

    /* --- LANDING PAGE --- */
    #pageLanding { 
        width: 100vw; height: 100vh; 
        display: none; 
        background: var(--bg-light);
    }
    #pageLanding.active { display: flex; }

    /* LEFT SIDE */
    .landing-left {
        flex: 1.2; position: relative;
        background: url('https://images.unsplash.com/photo-1555660232-2d487f54c935?q=80&w=1920&auto=format&fit=crop');
        background-size: cover; background-position: center; overflow: hidden;
    }
    .landing-left::after {
        content: ""; position: absolute; inset: 0;
        background: linear-gradient(135deg, rgba(0, 94, 184, 0.85), rgba(0, 166, 81, 0.7)); z-index: 1;
    }
    .landing-left-content {
        position: relative; z-index: 2; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; padding: 60px; color: white;
    }
    .hero-badge { background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); padding: 8px 16px; border-radius: 50px; display: inline-block; margin-bottom: 20px; font-weight: 600; border: 1px solid rgba(255,255,255,0.3); }
    .hero-title { font-size: 3.5rem; font-weight: 800; line-height: 1.1; margin-bottom: 15px; text-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    .hero-desc { font-size: 1.1rem; opacity: 0.9; max-width: 600px; line-height: 1.6; }

    /* RIGHT SIDE */
    .landing-right {
        flex: 0.8; background: var(--card-bg); display: flex; align-items: center; justify-content: center; padding: 40px; position: relative;
        transition: background 0.3s;
    }
    .menu-container { width: 100%; max-width: 420px; }
    .welcome-text h2 { color: var(--mrt-blue); font-weight: 800; font-size: 2rem; margin-bottom: 5px; }
    .welcome-text p { color: var(--text-muted); margin-bottom: 30px; font-size: 1rem; }
    .menu-label { font-size: 0.75rem; color: #94a3b8; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 15px; }

    /* BUTTONS LANDING */
    .menu-btn {
        display: flex; align-items: center; justify-content: space-between;
        padding: 16px 20px; margin-bottom: 15px;
        border-radius: 16px; cursor: pointer;
        text-decoration: none; transition: all 0.25s ease;
        border: 2px solid transparent; background: var(--input-bg);
    }
    .btn-wrap { display: flex; align-items: center; gap: 15px; }
    .btn-icon {
        width: 48px; height: 48px; border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.3rem; flex-shrink: 0; transition: 0.3s;
    }
    .btn-info { display: flex; flex-direction: column; }
    .btn-title { font-weight: 700; font-size: 1rem; line-height: 1.2; color: var(--text-dark); }
    .btn-desc { font-size: 0.8rem; font-weight: 400; margin-top: 2px; color: var(--text-muted); }

    /* PRIMARY */
    .menu-btn.primary { background-color: var(--mrt-blue); color: white; box-shadow: 0 4px 15px rgba(0, 94, 184, 0.25); border: none; }
    .menu-btn.primary .btn-icon { background: rgba(255,255,255,0.2); color: white; }
    .menu-btn.primary .btn-title, .menu-btn.primary .btn-desc { color: white; }
    .menu-btn.primary:hover { background-color: var(--mrt-dark-blue); transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0, 94, 184, 0.4); }

    /* OUTLINE */
    .menu-btn.outline { border: 1px solid var(--border-color); color: var(--text-dark); }
    .menu-btn.outline .btn-icon { background: rgba(0,0,0,0.05); color: var(--text-dark); }
    body.dark-mode .menu-btn.outline .btn-icon { background: #333; color: #fff; }
    
    .menu-btn.outline:hover { border-color: var(--mrt-blue); transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
    .menu-btn.outline:hover .btn-icon { background: rgba(0, 94, 184, 0.1); color: var(--mrt-blue); }
    .menu-btn.outline:hover .btn-title { color: var(--mrt-blue); }

    .landing-footer { margin-top: 40px; text-align: center; font-size: 0.8rem; color: var(--text-muted); font-weight: 500; }

    /* --- INNER PAGES --- */
    .page { display: none; padding-bottom: 50px; animation: fadeIn 0.3s ease; }
    .page.active { display: block; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
    
    .cardx { background: var(--card-bg); border-radius: 16px; border: 1px solid var(--border-color); box-shadow: 0 2px 6px rgba(0,0,0,0.04); overflow: hidden; margin-bottom: 20px; transition: background 0.3s; }
    .cardx-h { padding: 18px 24px; border-bottom: 1px solid var(--border-color); background: var(--card-bg); display:flex; justify-content:space-between; align-items:center; }
    .cardx-b { padding: 24px; }

    /* EDITOR */
    .rich-editor-container { border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; background: var(--input-bg); }
    .editor-toolbar { background: var(--bg-light); padding: 6px; border-bottom: 1px solid var(--border-color); display: flex; gap: 4px; }
    .editor-btn { width: 30px; height: 30px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg); display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-muted); font-size: 0.9rem; }
    .editor-btn:hover { background: var(--border-color); color: var(--mrt-blue); }
    .editor-content { min-height: 100px; padding: 12px; overflow-y: auto; outline: none; color: var(--text-dark); }
    .editor-content ul, .editor-content ol { padding-left: 20px; margin-bottom: 0; }

    /* GUIDE */
    .guide-step { display: flex; gap: 15px; margin-bottom: 20px; background: var(--card-bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border-color); }
    .step-number { flex-shrink: 0; width: 35px; height: 35px; background: var(--mrt-blue); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; }

    /* FLOATING DARK MODE BUTTON */
    .float-dark-btn {
        position: fixed; left: 20px; bottom: 20px;
        width: 50px; height: 50px;
        background: var(--card-bg);
        border: 2px solid var(--border-color);
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.5rem; color: var(--text-dark);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        cursor: pointer; z-index: 9999;
        transition: 0.3s;
    }
    .float-dark-btn:hover { transform: scale(1.1); border-color: var(--mrt-blue); color: var(--mrt-blue); }

    /* HIDE BLOGGER */
    #navbar-iframe { display: none !important; height: 0 !important; visibility: hidden !important; }
    .header-outer, .header-inner, .region-header, .Header { display: none !important; }
    body { margin-top: 0 !important; padding-top: 0 !important; }

    /* PRINT */
    .watermark { display: none; }
    @media print {
        @page { size: A4; margin: 1cm; }
        body { background: #fff !important; color: #000 !important; font-size: 11pt; display: block; overflow: visible; }
        .topbar, .no-print, .btn, .landing-right, .float-dark-btn { display: none !important; }
        .page { display: none; }
        .page.print-active { display: block !important; width: 100% !important; margin: 0 !important; padding: 0 !important; }
        .cardx { border: none !important; box-shadow: none !important; background: #fff !important; }
        .cardx-b { padding: 0 !important; }
        .bg-light { background-color: #f8fafc !important; -webkit-print-color-adjust: exact; border: 1px solid #ddd; }
        .editor-content, #wr_deskripsi, #wr_catatan { white-space: normal !important; word-wrap: break-word !important; color: #000 !important; }
        .signature-row { display: flex !important; justify-content: space-between !important; }
        .signature-col { width: 48% !important; float: left !important; text-align: center !important; }
        .watermark { display: block; position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%) rotate(-45deg); font-size: 4rem; color: rgba(0,0,0,0.05); font-weight: 900; z-index: -1; pointer-events: none; }
    }
  </style>
</head>

<body oncontextmenu="return false;"> 

  <button class="float-dark-btn no-print" onclick="toggleDarkMode()" title="Mode Gelap">
      <i class="bi bi-moon-stars-fill" id="darkModeIcon"></i>
  </button>

  <div class="watermark">DOKUMEN TERBATAS</div>

  <div class="topbar no-print" id="innerNav">
    <div class="container py-2 d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2 text-dark fw-bold">
        <i class="bi bi-rocket-takeoff text-primary fs-4"></i> GASS Terus!
      </div>
      <div class="d-flex gap-1 align-items-center">
        <button class="btn-nav" onclick="routeTo('landing')"><i class="bi bi-house-door"></i> Beranda</button>
        <button class="btn-nav" onclick="routeTo('workSheet')"><i class="bi bi-file-earmark-text"></i> Kertas Kerja</button>
        
        <div class="nav-item-dropdown">
            <button class="btn-nav"><i class="bi bi-ui-checks"></i> Evaluasi KPI <i class="bi bi-chevron-down ms-1" style="font-size:0.7em;"></i></button>
            <div class="dropdown-content">
                <button onclick="routeTo('single')">Evaluasi KPI 2025</button>
                <button onclick="routeTo('kpi2026')">Evaluasi KPI 2026</button>
            </div>
        </div>

        <button class="btn-nav" onclick="routeTo('guide')"><i class="bi bi-question-circle"></i> Panduan</button>
      </div>
    </div>
  </div>

  <section id="pageLanding" class="active no-print">
    <div class="landing-left">
        <div class="landing-left-content">
            <div>
                <div class="hero-badge"><i class="bi bi-building me-2"></i>General Affairs Department</div>
                <h1 class="hero-title">Sistem Pelaporan<br>Kegiatan Operasional</h1>
                <p class="hero-desc">Platform internal General Affairs Department untuk pembuatan laporan, kertas kerja, dan evaluasi kinerja tahunan.</p>
            </div>
        </div>
    </div>

    <div class="landing-right">
        <div class="menu-container">
            <div class="welcome-text">
                <h2>Selamat Datang!</h2>
            </div>
            
            <div class="menu-label">PELAPORAN HARIAN</div>
            <div class="menu-btn outline" onclick="routeTo('workSheet')">
                <div class="btn-wrap">
                    <div class="btn-icon"><i class="bi bi-journal-richtext"></i></div>
                    <div class="btn-info">
                        <div class="btn-title">Buat Kertas Kerja</div>
                        <div class="btn-desc">Laporan Patrol, Project, & Incident</div>
                    </div>
                </div>
                <i class="bi bi-arrow-right"></i>
            </div>

            <div class="menu-label mt-4">EVALUASI KINERJA</div>
            
			            <div class="menu-btn outline" onclick="routeTo('kpi2026')">
                <div class="btn-wrap">
                    <div class="btn-icon"><i class="bi bi-clipboard-data text-primary"></i></div>
                    <div class="btn-info">
                        <div class="btn-title">Evaluasi KPI 2026</div>
                        <div class="btn-desc">Pelaporan Kinerja Tahun 2026</div>
                    </div>
                </div>
                <i class="bi bi-arrow-right"></i>
            </div>
			
			<div class="menu-btn outline" onclick="routeTo('single')">
                <div class="btn-wrap">
                    <div class="btn-icon"><i class="bi bi-clipboard-data text-success"></i></div>
                    <div class="btn-info">
                        <div class="btn-title">Evaluasi KPI 2025</div>
                        <div class="btn-desc">Pelaporan Kinerja Tahun 2025</div>
                    </div>
                </div>
                <i class="bi bi-arrow-right"></i>
            </div>
			
			<div class="menu-label">MASIH BINGUNG CARANYA?</div>

            <div class="menu-btn outline" onclick="routeTo('guide')">
                <div class="btn-wrap">
                    <div class="btn-icon"><i class="bi bi-book text-primary"></i></div>
                    <div class="btn-info">
                        <div class="btn-title">Panduan</div>
                        <div class="btn-desc">Cara penggunaan sistem</div>
                    </div>
                </div>
                <i class="bi bi-arrow-right text-muted"></i>
            </div>

            <div class="landing-footer">
                Dibuat dengan ❤️ oleh QM Unit - 2026
            </div>
        </div>
    </div>
  </section>

  <div class="container my-5">

    <section id="pageGuide" class="page">
        <h3 class="fw-bold mb-4"><i class="bi bi-book-half me-2"></i>Panduan Penggunaan</h3>
        <div class="row g-5">
            <div class="col-md-6">
                <h5 class="mb-3 text-primary border-bottom pb-2">Panduan Kertas Kerja</h5>
                <div class="guide-step">
                    <div class="step-number">1</div>
                    <div><h6 class="fw-bold">Pilih Identitas</h6><p class="small text-muted mb-0">Pilih nama, NIK & Jabatan terisi otomatis.</p></div>
                </div>
                <div class="guide-step">
                    <div class="step-number">2</div>
                    <div><h6 class="fw-bold">Isi Data</h6><p class="small text-muted mb-0">Isi deskripsi, catatan, dan upload foto.</p></div>
                </div>
                <div class="guide-step">
                    <div class="step-number">3</div>
                    <div><h6 class="fw-bold">Cetak</h6><p class="small text-muted mb-0">Generate dan Print PDF.</p></div>
                </div>
            </div>
            <div class="col-md-6">
                 <h5 class="mb-3 text-success border-bottom pb-2">Panduan KPI</h5>
                 <div class="guide-step">
                    <div class="step-number" style="background:var(--mrt-green)">1</div>
                    <div><h6 class="fw-bold">Pilih Tahun & KPI</h6><p class="small text-muted mb-0">Pilih menu KPI 2025 atau 2026 sesuai kebutuhan.</p></div>
                </div>
                <div class="guide-step">
                    <div class="step-number" style="background:var(--mrt-green)">2</div>
                    <div><h6 class="fw-bold">Input & Validasi</h6><p class="small text-muted mb-0">Isi realisasi, upload bukti, dan tanda tangan digital.</p></div>
                </div>
            </div>
        </div>
    </section>

    <section id="pageWorkSheet" class="page">
        <div class="cardx">
            <div class="cardx-h">
                <h5 class="text-primary m-0"><i class="bi bi-file-earmark-text me-2"></i>Formulir Kertas Kerja</h5>
                <span class="badge bg-light text-dark border">Input Data</span>
            </div>
            <div class="cardx-b">
                <form id="wsForm">
                    <div class="row g-3 mb-4">
                        <div class="col-md-12"><label class="form-label fw-bold">Nama Karyawan <span class="text-danger">*</span></label><select class="form-select" id="ws_nama" onchange="ws_handleNameChange()" required><option value="" selected disabled>-- Pilih Nama --</option></select></div>
                        <div class="col-md-6"><label class="form-label small text-muted">NIK</label><input type="text" class="form-control bg-light" id="ws_nik" readonly></div>
                        <div class="col-md-6"><label class="form-label small text-muted">Jabatan</label><input type="text" class="form-control bg-light" id="ws_jabatan" readonly></div>
                    </div>
                    <div class="p-3 bg-light rounded border mb-4">
                        <h6 class="fw-bold mb-3 text-primary">Detail Pelaksanaan</h6>
                        <div class="row g-3">
                            <div class="col-md-8"><label class="form-label fw-bold">Judul Kegiatan</label><input type="text" class="form-control" id="ws_judul" required></div>
                            <div class="col-md-4"><label class="form-label fw-bold">Tanggal</label><input type="date" class="form-control" id="ws_tanggal" required></div>
                            <div class="col-md-6"><label class="form-label fw-bold">Jenis</label><select class="form-select" id="ws_jenis"><option>5R Patrol</option><option>Project Monitoring</option><option>Project Evaluation</option><option>Incident Report</option><option>Lainnya</option></select></div>
                            <div class="col-md-6"><label class="form-label fw-bold">Lokasi</label><select class="form-select" id="ws_lokasiSelect" onchange="ws_handleLocationChange()"><option>Wisma Nusantara</option><option>Transport Hub</option><option>Depo Lebak Bulus</option><option value="Lainnya">Lainnya...</option></select><input type="text" class="form-control mt-2" id="ws_lokasiInput" style="display:none;"></div>
                        </div>
                    </div>
                    <div class="mb-4"><label class="form-label fw-bold">Deskripsi</label><div class="rich-editor-container"><div class="editor-toolbar"><button type="button" class="editor-btn" onclick="execCmd('bold')"><i class="bi bi-type-bold"></i></button><button type="button" class="editor-btn" onclick="execCmd('italic')"><i class="bi bi-type-italic"></i></button><button type="button" class="editor-btn" onclick="execCmd('insertUnorderedList')"><i class="bi bi-list-ul"></i></button></div><div id="ws_deskripsi" class="editor-content" contenteditable="true"></div></div></div>
                    <div class="mb-4"><label class="form-label fw-bold">Catatan</label><div class="rich-editor-container"><div class="editor-toolbar"><button type="button" class="editor-btn" onclick="execCmd('bold')"><i class="bi bi-type-bold"></i></button><button type="button" class="editor-btn" onclick="execCmd('italic')"><i class="bi bi-type-italic"></i></button></div><div id="ws_catatan" class="editor-content" contenteditable="true"></div></div></div>
                    <div class="mb-4 p-3 border rounded bg-light"><label class="form-label fw-bold">Bukti Foto</label><div id="ws_photoContainer"><input type="file" class="form-control ws_photo_input" accept="image/*" required></div><button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="ws_addPhoto()">+ Tambah Foto</button></div>
                    <div class="p-3 border rounded mb-4" style="background:rgba(239, 246, 255, 0.5);"><h6 class="fw-bold mb-3">Validasi Atasan</h6><div class="row g-3"><div class="col-md-6"><label class="form-label fw-bold">Nama Atasan</label><input type="text" class="form-control" id="ws_nama_atasan" required></div><div class="col-md-6"><label class="form-label fw-bold">Jabatan Atasan</label><input type="text" class="form-control" id="ws_jabatan_atasan" required></div></div></div>
                    <button type="button" class="btn btn-primary w-100 py-3 fw-bold rounded-3 shadow-sm" onclick="ws_generate()"><i class="bi bi-printer me-2"></i>Cetak Laporan</button>
                </form>
            </div>
        </div>
    </section>

    <section id="pageSingle" class="page">
        <div class="cardx">
            <div class="cardx-h"><h5 class="text-primary m-0"><i class="bi bi-clipboard-data me-2"></i>Evaluasi KPI 2025</h5></div>
            <div class="cardx-b">
                <form id="singleForm">
                   <div class="row g-3 mb-3">
                       <div class="col-md-12"><label class="form-label fw-bold">Nama Karyawan</label><select class="form-select" id="s_nama" onchange="single_handleNameChange()" required><option value="">-- Pilih --</option></select></div>
                       <div class="col-md-6"><label class="form-label small text-muted">NIK</label><input type="text" class="form-control bg-light" id="s_nik" readonly></div>
                       <div class="col-md-6"><label class="form-label small text-muted">Jabatan</label><input type="text" class="form-control bg-light" id="s_jabatan" readonly></div>
                   </div>
                   <div class="mb-4 border p-3 rounded bg-light"><label class="form-label fw-bold">Pilih Item KPI 2025</label><select class="form-select" id="s_obj" onchange="single_renderKeyResults()" required><option value="">-- Pilih Nama Terlebih Dahulu --</option></select></div>
                   <div id="single_dynamic" style="display:none;"><div class="alert alert-primary py-2 small mb-4"><strong>Formula:</strong> <span id="s_formula"></span></div><h6 class="fw-bold mb-3">Input Realisasi</h6><div id="s_krContainer" class="mb-4 gap-3 d-flex flex-column"></div><div class="mb-4 p-3 border rounded"><label class="fw-bold form-label">Upload Bukti Utama</label><input type="file" class="form-control mb-2" id="s_buktiMain" required><div class="rich-editor-container"><div id="s_editor_main" class="editor-content" contenteditable="true" placeholder="Beri keterangan bukti..."></div></div></div><div class="form-check mb-4 p-3 border rounded bg-light-subtle"><input class="form-check-input" type="checkbox" id="s_declare" required style="transform: scale(1.2);"><label class="form-check-label fw-bold ms-2 pt-1">Saya menyatakan data yang diisi adalah BENAR.</label></div><div class="mb-4"><label class="fw-bold form-label">Upload Tanda Tangan Digital</label><input type="file" class="form-control" id="s_ttd" accept="image/*" required></div><button type="button" class="btn btn-success w-100 py-3 rounded-3 fw-bold fs-5 shadow-sm" onclick="single_calculate()"><i class="bi bi-calculator me-2"></i>Hitung & Lihat Hasil</button></div>
                </form>
            </div>
        </div>
    </section>

    <section id="pageKpi2026" class="page">
        <div class="cardx">
            <div class="cardx-h"><h5 class="text-primary m-0"><i class="bi bi-clipboard-data me-2"></i>Evaluasi KPI 2026</h5></div>
            <div class="cardx-b">
                <form id="kpi2026Form">
                   <div class="row g-3 mb-3">
                       <div class="col-md-12"><label class="form-label fw-bold">Nama Karyawan</label><select class="form-select" id="k26_nama" onchange="k26_handleNameChange()" required><option value="">-- Pilih --</option></select></div>
                       <div class="col-md-6"><input class="form-control bg-light" id="k26_nik" readonly placeholder="NIK"></div>
                       <div class="col-md-6"><input class="form-control bg-light" id="k26_jabatan" readonly placeholder="Jabatan"></div>
                   </div>
                   <div class="mb-4 border p-3 rounded bg-light">
                       <label class="form-label fw-bold">Pilih Item KPI 2026</label>
                       <select class="form-select" id="k26_obj" onchange="k26_renderKeyResults()" required><option value="">-- Pilih Nama Terlebih Dahulu --</option></select>
                   </div>
                   
                   <div id="k26_dynamic" style="display:none;">
                       <div class="alert alert-info py-2 small mb-4"><strong>Formula:</strong> <span id="k26_formula"></span></div>
                       <h6 class="fw-bold mb-3">Input Key Result (KR)</h6>
                       <div id="k26_krContainer" class="mb-4 gap-3 d-flex flex-column"></div>
                       
                       <div class="mb-4 p-3 border rounded">
                           <label class="fw-bold form-label">Upload Bukti Utama</label>
                           <input type="file" class="form-control mb-2" id="k26_buktiMain" required>
                           <div class="rich-editor-container">
                               <div class="editor-toolbar">
                                   <button type="button" class="editor-btn" onclick="execCmd('bold')"><i class="bi bi-type-bold"></i></button>
                                   <button type="button" class="editor-btn" onclick="execCmd('italic')"><i class="bi bi-type-italic"></i></button>
                                   <button type="button" class="editor-btn" onclick="execCmd('insertUnorderedList')"><i class="bi bi-list-ul"></i></button>
                               </div>
                               <div id="k26_editor_main" class="editor-content" contenteditable="true" placeholder="Beri keterangan bukti..."></div>
                           </div>
                           <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="k26_addExtraEvidence()">+ Tambah Bukti Lain</button>
                           <div id="k26_extraWrap" class="mt-2"></div>
                       </div>
                       
                       <div class="form-check mb-4 p-3 border rounded bg-light-subtle">
                           <input class="form-check-input" type="checkbox" id="k26_declare" required style="transform: scale(1.2);">
                           <label class="form-check-label fw-bold ms-2 pt-1">Saya menyatakan data yang diisi adalah BENAR.</label>
                       </div>
                       
                       <div class="mb-4"><label class="fw-bold form-label">Upload Tanda Tangan Digital</label><input type="file" class="form-control" id="k26_ttd" accept="image/*" required></div>
                       
                       <button type="button" class="btn btn-primary w-100 py-3 rounded-3 fw-bold fs-5 shadow-sm" onclick="k26_calculate()">
                        <i class="bi bi-calculator me-2"></i>Hitung & Lihat Hasil 2026
                       </button>
                   </div>
                </form>
            </div>
        </div>
    </section>

    <section id="pageSingleReport" class="page">
        <div class="d-flex justify-content-between mb-4 no-print shadow-sm p-3 rounded border bg-white align-items-center">
            <h5 class="m-0 fw-bold text-success">Hasil Perhitungan KPI</h5>
            <div class="d-flex gap-2"><button class="btn btn-sm btn-outline-dark" onclick="routeTo('landing')">Home</button><button class="btn btn-sm btn-primary fw-bold" onclick="window.print()">Print PDF</button></div>
        </div>
        <div class="cardx" id="singleReportContent"><div class="cardx-b p-5"><h4 class="text-primary fw-bold mb-4 text-uppercase">BUKTI PENILAIAN KPI</h4><div class="row mt-4 mb-5 align-items-end"><div class="col-md-8 col-8"><table class="table table-borderless table-sm small mb-0"><tr><td class="text-muted w-25">Nama</td><td class="fw-bold fs-6" id="sr_nama"></td></tr><tr><td class="text-muted">Jabatan</td><td id="sr_jabatan_kpi"></td></tr><tr><td class="text-muted">Item KPI</td><td class="fw-bold text-primary fs-6" id="sr_obj"></td></tr></table></div><div class="col-md-4 col-4 text-center"><div class="border rounded p-3 bg-light" style="border-color:#bbf7d0 !important; background:#f0fdf4 !important;"><small class="text-muted fw-bold ls-1">SKOR FINAL</small><h1 class="m-0 fw-bold text-success" style="font-size:3.5rem;" id="sr_sf">0</h1></div></div></div><h6 class="fw-bold border-bottom pb-2 mb-3">Rincian Perhitungan</h6><table class="table table-bordered table-sm text-center align-middle small mb-5"><thead class="table-light fw-bold"><tr><th>Key Result</th><th width="15%">Target</th><th width="15%">Realisasi</th><th width="12%">Bobot KR</th><th width="12%">Skor</th></tr></thead><tbody id="sr_rows"></tbody><tfoot class="fw-bold bg-light" style="border-top:2px solid #e2e8f0;"><tr><td colspan="3" class="text-end pe-3">TOTAL</td><td id="sr_totalBobot"></td><td id="sr_totalScore" class="text-primary"></td></tr></tfoot></table><div class="page-break"><h6 class="fw-bold border-bottom pb-2 mb-3">Lampiran Bukti</h6><div id="sr_evi" class="mt-3 p-3 border rounded bg-light"></div></div><div class="row mt-5 pt-5 signature-row"><div class="col-md-6 col-6 offset-md-6 offset-6 text-center signature-col"><p class="mb-2">Jakarta, <span id="sr_date"></span></p><p class="mb-1">Dibuat Oleh,</p><img id="sr_ttdImg" style="height:80px; width:auto; display:block; margin:0 auto; object-fit:contain;"><p class="fw-bold text-decoration-underline mt-2 text-uppercase mb-0" id="sr_sigNama"></p><p class="small text-muted" id="sr_sigJabatan"></p></div></div></div></div>
    </section>

  </div>

<script>
// --- TOGGLE DARK MODE ---
function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const icon = document.getElementById('darkModeIcon');
    if (document.body.classList.contains('dark-mode')) {
        icon.classList.remove('bi-moon-stars-fill');
        icon.classList.add('bi-sun-fill');
    } else {
        icon.classList.remove('bi-sun-fill');
        icon.classList.add('bi-moon-stars-fill');
    }
}

// --- DATA EMPLOYEES ---
const employees = [
  { name: "M. Ardhan Rafsanjani", title: "General Affairs Department Head", nik: "217051224" },
  { name: "Maya Satih Kanteyan", title: "Site Office and Head Office Facility Operation Section Head", nik: "218022377" },
  { name: "Waziruddin", title: "Depot Office Facility Operation Section Head", nik: "10077" },
  { name: "Rizki Aziz Radyantama", title: "Office Quality Facility Specialist", nik: "10395" },
  { name: "Annisa Mayangsari", title: "Site Office and Head Office Facility Operation Specialist", nik: "10003" },
  { name: "Rakhmat", title: "Site Office and Head Office Facility Operation Specialist", nik: "213031040" },
  { name: "Agung Prasetyo Wicaksono", title: "Site Office and Head Office Facility Operation Specialist", nik: "218111585" },
  { name: "Siti Zahratus Solihat", title: "Site Office and Head Office Facility Operation Specialist", nik: "10025" },
  { name: "Abdul Ajid", title: "Depot Office Facility Operation Specialist", nik: "217111362" },
  { name: "Dharisa Inayah Ramadhan", title: "Depot Office Facility Operation Specialist", nik: "10523" }
];

// --- DATA KPI 2025 (RESTORED FULL) ---
const employeeWeights2025 = {
  "M. Ardhan Rafsanjani": { "Terlaksananya kegiatan budget controlling": 10, "Tercapainya success rate pengelolaan layanan umum": 15, "Jumlah proyek atau inovasi layanan": 10, "Pencapaian Pembuatan SOP dan Instruksi Kerja Departemen": 15, "Persetujuan alternatif lokasi kerja kantor pusat PT MRT Jakarta (Perseroda)": 15, "Tingkat pemenuhan IDP": 2.5, "Indeks Knowledge Management": 2.5, "GRC Index": 2.5, "Indeks Kepuasan Stakeholder": 2.5, "Indeks Penyelesaian Audit": 2.5, "Jumlah permintaan perbaikan yang diselesaikan tepat waktu": 7.5, "Petty Cash Handling": 7.5, "Tercapainya Akurasi dan Ketepatan Waktu Pembayaran Tagihan Area SOHO dan Depo Lebak Bulus": 7.5 },
  "Rizki Aziz Radyantama": { "Tercapainya success rate pengelolaan layanan umum": 10, "Jumlah proyek atau inovasi layanan": 12.5, "Pencapaian Pembuatan SOP dan Instruksi Kerja Departemen": 12.5, "Persetujuan alternatif lokasi kerja kantor pusat PT MRT Jakarta (Perseroda)": 20, "Kegiatan Daur Ulang Limbah Seragam": 20, "Tingkat pemenuhan IDP": 2.5, "Indeks Knowledge Management": 2.5, "GRC Index": 10, "Indeks Kepuasan Stakeholder": 15, "Indeks Penyelesaian Audit": 2.5 },
  "Waziruddin": { "Terlaksananya kegiatan budget controlling": 5, "Tercapainya success rate pengelolaan layanan umum": 15, "Jumlah proyek atau inovasi layanan": 10, "Jumlah permintaan perbaikan yang diselesaikan tepat waktu": 10, "Tercapainya Akurasi dan Ketepatan Waktu Pembayaran Tagihan Area Depo Lebak Bulus": 10, "Petty Cash Handling": 10, "Pengelolaan Pelayanan Tenaga Alih Daya": 10, "Pencapaian Pembuatan SOP dan Instruksi Kerja Departemen": 10, "Persetujuan alternatif lokasi kerja kantor pusat PT MRT Jakarta (Perseroda)": 10, "Tingkat pemenuhan IDP": 2.5, "Indeks Knowledge Management": 2.5, "GRC Index": 10, "Indeks Kepuasan Stakeholder": 2.5, "Indeks Penyelesaian Audit": 2.5, "Pengelolaan Fasilitas Kantor": 10 },
  "Dharisa Inayah Ramadhan": { "Terlaksananya kegiatan budget controlling": 10, "Tercapainya success rate pengelolaan layanan umum": 10, "Jumlah proyek atau inovasi layanan": 10, "Petty Cash Handling": 15, "Tercapainya Akurasi dan Ketepatan Waktu Pembayaran Tagihan Area Depo Lebak Bulus": 10, "Tingkat pemenuhan IDP": 2.5, "Indeks Knowledge Management": 2.5, "Pengelolaan Fasilitas Kantor": 10, "Indeks Kepuasan Stakeholder": 2.5, "Indeks Penyelesaian Audit": 2.5, "Kegiatan Daur Ulang Limbah Seragam": 10, "Pencapaian Pembuatan SOP dan Instruksi Kerja Departemen": 5, "Pengelolaan Pelayanan Tenaga Alih Daya": 10 },
  "Abdul Ajid": { "Terlaksananya kegiatan budget controlling": 5, "Tercapainya success rate pengelolaan layanan umum": 10, "Jumlah proyek atau inovasi layanan": 10, "Jumlah permintaan perbaikan yang diselesaikan tepat waktu": 12.5, "Petty Cash Handling": 7.5, "Tercapainya Akurasi dan Ketepatan Waktu Pembayaran Tagihan Area Depo Lebak Bulus": 10, "Pencapaian Pembuatan SOP dan Instruksi Kerja Departemen": 10, "Persetujuan alternatif lokasi kerja kantor pusat PT MRT Jakarta (Perseroda)": 7.5, "Tingkat pemenuhan IDP": 2.5, "Indeks Knowledge Management": 2.5, "Pengelolaan Fasilitas Kantor": 10, "Indeks Kepuasan Stakeholder": 2.5, "Indeks Penyelesaian Audit": 2.5, "Pengelolaan Pelayanan Tenaga Alih Daya": 7.5 },
  "Maya Satih Kanteyan": { "Terlaksananya kegiatan budget controlling": 10, "Tercapainya success rate pengelolaan layanan umum": 10, "Jumlah proyek atau inovasi layanan": 7.5, "Jumlah permintaan perbaikan yang diselesaikan tepat waktu": 10, "Petty Cash Handling": 10, "Tercapainya Akurasi dan Ketepatan Waktu Pembayaran Tagihan Area SOHO dan Depo Lebak Bulus": 10, "Pengelolaan Pelayanan Tenaga Alih Daya": 10, "Pencapaian Pembuatan SOP dan Instruksi Kerja Departemen": 7.5, "Persetujuan alternatif lokasi kerja kantor pusat PT MRT Jakarta (Perseroda)": 15, "Tingkat pemenuhan IDP": 2.5, "Indeks Knowledge Management": 2.5, "Pengelolaan Fasilitas Kantor": 10, "Indeks Kepuasan Stakeholder": 2.5, "Indeks Penyelesaian Audit": 2.5 },
  "Siti Zahratus Solihat": { "Terlaksananya kegiatan budget controlling": 15, "Tercapainya success rate pengelolaan layanan umum": 10, "Jumlah proyek atau inovasi layanan": 10, "Petty Cash Handling": 15, "Tercapainya Akurasi dan Ketepatan Waktu Pembayaran Tagihan Area SOHO dan Depo Lebak Bulus": 12.5, "Pengelolaan Pelayanan Tenaga Alih Daya": 15, "Pencapaian Pembuatan SOP dan Instruksi Kerja Departemen": 12.5, "Tingkat pemenuhan IDP": 2.5, "Indeks Knowledge Management": 2.5, "Indeks Kepuasan Stakeholder": 2.5, "Indeks Penyelesaian Audit": 2.5 },
  "Annisa Mayangsari": { "Terlaksananya kegiatan budget controlling": 10, "Tercapainya success rate pengelolaan layanan umum": 12.5, "Jumlah proyek atau inovasi layanan": 12.5, "Petty Cash Handling": 15, "Tercapainya Akurasi dan Ketepatan Waktu Pembayaran Tagihan Area SOHO": 10, "Pengelolaan Pelayanan Tenaga Alih Daya": 10, "Pencapaian Pembuatan SOP dan Instruksi Kerja Departemen": 10, "Kegiatan Daur Ulang Limbah Seragam": 5, "Tingkat pemenuhan IDP": 2.5, "Indeks Knowledge Management": 2.5, "GRC Index": 10, "Indeks Kepuasan Stakeholder": 2.5, "Indeks Penyelesaian Audit": 2.5, "Pengelolaan Fasilitas Kantor": 10 },
  "Agung Prasetyo Wicaksono": { "Terlaksananya kegiatan budget controlling": 5, "Tercapainya success rate pengelolaan layanan umum": 10, "Jumlah proyek atau inovasi layanan": 10, "Jumlah permintaan perbaikan yang diselesaikan tepat waktu": 12.5, "Tercapainya Akurasi dan Ketepatan Waktu Pembayaran Tagihan Area SOHO": 10, "Petty Cash Handling": 7.5, "Pencapaian Pembuatan SOP dan Instruksi Kerja Departemen": 10, "Pengelolaan Pelayanan Tenaga Alih Daya": 7.5, "Persetujuan alternatif lokasi kerja kantor pusat PT MRT Jakarta (Perseroda)": 7.5, "Tingkat pemenuhan IDP": 2.5, "Indeks Knowledge Management": 2.5, "Pengelolaan Fasilitas Kantor": 10, "Indeks Kepuasan Stakeholder": 2.5, "Indeks Penyelesaian Audit": 2.5 },
  "Rakhmat": { "Terlaksananya kegiatan budget controlling": 5, "Tercapainya success rate pengelolaan layanan umum": 10, "Jumlah proyek atau inovasi layanan": 10, "Jumlah permintaan perbaikan yang diselesaikan tepat waktu": 12.5, "Tercapainya Akurasi dan Ketepatan Waktu Pembayaran Tagihan Area SOHO": 10, "Petty Cash Handling": 7.5, "Pencapaian Pembuatan SOP dan Instruksi Kerja Departemen": 10, "Pengelolaan Pelayanan Tenaga Alih Daya": 7.5, "Persetujuan alternatif lokasi kerja kantor pusat PT MRT Jakarta (Perseroda)": 7.5, "Tingkat pemenuhan IDP": 2.5, "Indeks Knowledge Management": 2.5, "Pengelolaan Fasilitas Kantor": 10, "Indeks Kepuasan Stakeholder": 2.5, "Indeks Penyelesaian Audit": 2.5 }
};

const kpiData2025 = {
  "Terlaksananya kegiatan budget controlling": { formula: "Realisasi jumlah kegiatan terserap berdasarkan RKA", items: [{ kr: "1. Memastikan ketersediaan anggaran untuk setiap kegiatan", target: 100, unit: "%", relativeWeight: 50 }, { kr: "2. Kegiatan reelokasi selesai max 1 bulan", target: 100, unit: "%", relativeWeight: 35 }, { kr: "3. Kegiatan terdokumentasi dan dilaporkan rutin", target: 12, unit: "Bulan", relativeWeight: 15 }] },
  "Tercapainya success rate pengelolaan layanan umum": { formula: "Realisasi penyelesaian kebutuhan layanan umum", items: [{ kr: "1. Menyelesaikan permintaan layanan umum sesuai SLA", target: 100, unit: "%", relativeWeight: 40 }, { kr: "2. Jumlah keluhan kategori menengah/tinggi < 40%", target: 10, unit: "%", relativeWeight: 30 }, { kr: "3. 100% permintaan layanan umum tercatat", target: 100, unit: "%", relativeWeight: 30 }] },
  "Jumlah proyek atau inovasi layanan": { formula: "Realisasi penyelesaian minimal 2 proyek atau inovasi perbaikan layanan dalam 1 tahun", items: [{ kr: "1. Memiliki minimal 1 proyek/inovasi per tahun", target: 1, unit: "Proyek", relativeWeight: 50 }, { kr: "2. Penyelesaian proyek 100%", target: 100, unit: "%", relativeWeight: 30 }, { kr: "3. Dokumentasi proyek tercatat lengkap", target: 100, unit: "%", relativeWeight: 20 }] },
  "Jumlah permintaan perbaikan yang diselesaikan tepat waktu": { formula: "Seluruh permintaan perbaikan selesai dan tercatat 100%, serta terdokumentasi", items: [{ kr: "1. Penyelesaian permintaan memenuhi 100% SLA", target: 100, unit: "%", relativeWeight: 50 }, { kr: "2. Seluruh permintaan perbaikan tercatat 100%", target: 100, unit: "%", relativeWeight: 50 }] },
  "Petty Cash Handling": { formula: "Realisasi pengelolaan petty cash (saldo & pengembalian)", items: [{ kr: "1. Pengajuan petty cash tercatat & terverifikasi", target: 100, unit: "%", relativeWeight: 25 }, { kr: "2. Laporan petty cash tersedia setiap bulan", target: 12, unit: "Bulan", relativeWeight: 25 }, { kr: "3. Pencairan reimbursement max 14 hari", target: 100, unit: "%", relativeWeight: 25 }, { kr: "4. Pertanggungjawaban uang muka max 7 hari", target: 100, unit: "%", relativeWeight: 25 }] },
  "Tercapainya Akurasi dan Ketepatan Waktu Pembayaran Tagihan Area SOHO dan Depo Lebak Bulus": { formula: "Realisasi pembayaran tahun berjalan & tidak ada keterlambatan stop service", items: [{ kr: "1. 100% pembayaran pada periode berjalan", target: 100, unit: "%", relativeWeight: 30 }, { kr: "2. Laporan pembayaran periodik per bulan", target: 12, unit: "Bulan", relativeWeight: 20 }, { kr: "3. Tidak ada keterlambatan pembayaran (stop service)", target: 12, unit: "Bulan", relativeWeight: 30 }, { kr: "4. Seluruh kegiatan pembayaran terdokumentasi", target: 100, unit: "%", relativeWeight: 20 }] },
  "Tercapainya Akurasi dan Ketepatan Waktu Pembayaran Tagihan Area SOHO": { formula: "Realisasi pembayaran tahun berjalan & tidak ada keterlambatan stop service", items: [{ kr: "1. 100% pembayaran pada periode berjalan", target: 100, unit: "%", relativeWeight: 30 }, { kr: "2. Laporan pembayaran periodik per bulan", target: 12, unit: "Bulan", relativeWeight: 20 }, { kr: "3. Tidak ada keterlambatan pembayaran (stop service)", target: 12, unit: "Bulan", relativeWeight: 30 }, { kr: "4. Seluruh kegiatan pembayaran terdokumentasi", target: 100, unit: "%", relativeWeight: 20 }] },
  "Tercapainya Akurasi dan Ketepatan Waktu Pembayaran Tagihan Area Depo Lebak Bulus": { formula: "Realisasi pembayaran tahun berjalan & tidak ada keterlambatan stop service", items: [{ kr: "1. 100% pembayaran pada periode berjalan", target: 100, unit: "%", relativeWeight: 30 }, { kr: "2. Laporan pembayaran periodik per bulan", target: 12, unit: "Bulan", relativeWeight: 20 }, { kr: "3. Tidak ada keterlambatan pembayaran (stop service)", target: 12, unit: "Bulan", relativeWeight: 30 }, { kr: "4. Seluruh kegiatan pembayaran terdokumentasi", target: 100, unit: "%", relativeWeight: 20 }] },
  "Pengelolaan Pelayanan Tenaga Alih Daya": { formula: "Realisasi pelaksanaan kegiatan pelatihan pada TAD", items: [{ kr: "1. 100% pelatihan TAD terlaksana", target: 100, unit: "%", relativeWeight: 40 }, { kr: "2. Dokumentasi & laporan kegiatan TAD", target: 100, unit: "%", relativeWeight: 30 }, { kr: "3. Coaching & counselling TAD", target: 1, unit: "Kali", relativeWeight: 30 }] },
  "Pencapaian Pembuatan SOP dan Instruksi Kerja Departemen": { formula: "Pembuatan/pembaruan minimal 3 prosedur dan 4 IK", items: [{ kr: "1. Pembuatan/pembaruan min 1 prosedur", target: 1, unit: "Dokumen", relativeWeight: 30 }, { kr: "2. Pembuatan/pembaruan min 3 IK", target: 3, unit: "Dokumen", relativeWeight: 30 }, { kr: "3. Refreshment pelayanan 1x", target: 1, unit: "Kegiatan", relativeWeight: 20 }, { kr: "4. SOP dan IK terdokumentasi", target: 100, unit: "%", relativeWeight: 20 }] },
  "Persetujuan alternatif lokasi kerja kantor pusat PT MRT Jakarta (Perseroda)": { formula: "Tersedianya kajian perpindahan kantor pusat yang disetujui", items: [{ kr: "1. Market survey kepada 3 penyedia", target: 3, unit: "Lokasi", relativeWeight: 25 }, { kr: "2. Laporan/kajian perpindahan", target: 100, unit: "%", relativeWeight: 25 }, { kr: "3. Persetujuan lokasi kantor", target: 100, unit: "%", relativeWeight: 25 }, { kr: "4. Komitmen anggaran", target: 100, unit: "%", relativeWeight: 25 }] },
  "Kegiatan Daur Ulang Limbah Seragam": { formula: "Kegiatan pengumpulan seragam di 3 lokasi", items: [{ kr: "1. Pengumpulan seragam di 3 lokasi", target: 3, unit: "Lokasi", relativeWeight: 50 }, { kr: "2. Dokumentasi kegiatan 100%", target: 100, unit: "%", relativeWeight: 50 }] },
  "Pengelolaan Fasilitas Kantor": { formula: "Pemenuhan permintaan dan lelang fasilitas", items: [{ kr: "1. 100% permintaan dipenuhi sesuai SLA", target: 100, unit: "%", relativeWeight: 40 }, { kr: "2. Lelang mebel minimal 1 kali/semester", target: 2, unit: "Kali", relativeWeight: 40 }, { kr: "3. Dokumentasi rutin bulanan", target: 12, unit: "Bulan", relativeWeight: 20 }] },
  "Tingkat pemenuhan IDP": { formula: "Input skor 0–5, skor 5 = 100%", items: [{ kr: "Tingkat pemenuhan IDP (Skor 0-5)", target: 5, unit: "Skor", relativeWeight: 100 }] },
  "Indeks Knowledge Management": { formula: "Input skor 0–5, skor 5 = 100%", items: [{ kr: "Indeks Knowledge Management (Skor 0-5)", target: 5, unit: "Skor", relativeWeight: 100 }] },
  "GRC Index": { formula: "Input skor 0–5, skor 5 = 100%", items: [{ kr: "GRC Index (Skor 0-5)", target: 5, unit: "Skor", relativeWeight: 100 }] },
  "Indeks Kepuasan Stakeholder": { formula: "Mencapai skor CSI di angka 4", items: [{ kr: "Skor CSI (0-5)", target: 4, unit: "Skor", relativeWeight: 100 }] },
  "Indeks Penyelesaian Audit": { formula: "Input skor 0–5, skor 5 = 100%", items: [{ kr: "Indeks Penyelesaian Audit (0-5)", target: 5, unit: "Skor", relativeWeight: 100 }] }
};

// --- DATA KPI 2026 ---
const kpiData2026 = {
    "Terlaksananya kegiatan budget controlling": {
        formula: "Realisasi jumlah kegiatan terserap berdasarkan RKA; Efisiensi anggaran; Laporan tepat waktu.",
        items: [
            { kr: "KR1: Tingkat realisasi penyerapan anggaran (Target 80%)", target: 80, unit: "%", relativeWeight: 40 },
            { kr: "KR2: Cost Efficiency non subsidi ((RKA-Biaya)/RKA)*100% (Target 5%)", target: 5, unit: "%", relativeWeight: 20 },
            { kr: "KR3: Kedisplinan pelaporan, diserahkan max tgl 15 (12 Bulan)", target: 12, unit: "Bulan", relativeWeight: 40 }
        ]
    },
    "Tercapainya success rate pengelolaan layanan umum": {
        formula: "Efektivitas Departemen GA dalam menanggapi permintaan layanan (SLA).",
        items: [
            { kr: "KR1: Response time dan SLA permintaan layanan terpenuhi", target: 100, unit: "%", relativeWeight: 20 },
            { kr: "KR2: Indeks Kepuasan Pelanggan Overall (Target 80)", target: 80, unit: "Skor", relativeWeight: 30 },
            { kr: "KR3: Indeks Kepuasan Pelanggan per Specialist (Target 80)", target: 80, unit: "Skor", relativeWeight: 30 },
            { kr: "KR4: Zero skip request per tahun", target: 0, unit: "Kali", relativeWeight: 20 }
        ]
    },
    "Indeks Kepuasan Stakeholder": {
        formula: "Sesuai nilai korporasi",
        items: [{ kr: "Pencapaian Indeks Kepuasan Stakeholder", target: 100, unit: "%", relativeWeight: 100 }]
    },
    "Jumlah Inisiatif Peningkatan Proses atau Efisiensi": {
        formula: "Kontribusi staf dalam mengidentifikasi ide perbaikan proses kerja.",
        items: [
            { kr: "KR1: Mempresentasikan project charter/deck ke Kadep (Min 1)", target: 1, unit: "Dokumen", relativeWeight: 20 },
            { kr: "KR2: Implementasi 100%", target: 100, unit: "%", relativeWeight: 30 },
            { kr: "KR3: Dokumentasi dan laporan akhir", target: 100, unit: "%", relativeWeight: 20 },
            { kr: "KR4: Membuat/Review SOP/IK/SE terkait (Min 1)", target: 1, unit: "Dokumen", relativeWeight: 30 }
        ]
    },
    "Petty Cash Handling": {
        formula: "Akurasi saldo dan pencatatan kas kecil.",
        items: [
            { kr: "KR1: Kepatuhan dokumentasi 100% (Invoice/Bon)", target: 100, unit: "%", relativeWeight: 20 },
            { kr: "KR2: Tersedianya 100% laporan rekonsiliasi petty cash tiap bulan", target: 12, unit: "Bulan", relativeWeight: 30 },
            { kr: "KR3: Akurasi rekonsiliasi balance", target: 100, unit: "%", relativeWeight: 30 },
            { kr: "KR4: Tidak ada keterlambatan pengisian kembali", target: 100, unit: "%", relativeWeight: 20 }
        ]
    },
    "Tingkat Kepatuhan Prosedur Keselamatan": {
        formula: "Implementasi kebijakan K3 di lingkungan kantor.",
        items: [
            { kr: "KR1: Tersedianya bukti laporan inspeksi fasilitas & K3 (4 Laporan)", target: 4, unit: "Laporan", relativeWeight: 30 },
            { kr: "KR2: Zero insiden keamanan dan keselamatan LTI", target: 0, unit: "Kasus", relativeWeight: 30 },
            { kr: "KR3: Penyelesaian tindak lanjut audit IMS tidak sampai tahap PTP", target: 100, unit: "%", relativeWeight: 30 },
            { kr: "KR4: Drill simulasi internal GA minimal 1x per tahun", target: 1, unit: "Kali", relativeWeight: 10 }
        ]
    },
    "Pengelolaan Inventaris Aset Kantor": {
        formula: "Keakuratan data aset kantor vs fisik di lapangan.",
        items: [
            { kr: "KR1: Terlaksananya kegiatan opname aset 1x", target: 1, unit: "Kali", relativeWeight: 25 },
            { kr: "KR2: Akurasi opname > 90%", target: 90, unit: "%", relativeWeight: 25 },
            { kr: "KR3: Tersedianya database aset GA yang dikelola & foto terbaru", target: 100, unit: "%", relativeWeight: 25 },
            { kr: "KR4: 100% mutasi dan peminjaman barang memiliki BAST", target: 100, unit: "%", relativeWeight: 25 }
        ]
    },
    "Tingkat Kesesuaian Rencana Pengadaan": {
        formula: "Jumlah pengadaan dengan waktu sesuai RPBJ.",
        items: [
            { kr: "KR1: 100% pengadaan dimulai prosesnya sesuai semester di RPBJ", target: 100, unit: "%", relativeWeight: 30 },
            { kr: "KR2: Pengadaan di luar RPBJ jumlahnya tidak mencapai > 30%", target: 30, unit: "%", relativeWeight: 30 },
            { kr: "KR3: Pembatalan pengadaan di RPBJ dilaksanakan sesuai prosedur", target: 100, unit: "%", relativeWeight: 20 },
            { kr: "KR4: Tidak ada penumpukan pengadaan di Q4", target: 100, unit: "%", relativeWeight: 20 }
        ]
    },
    "Penyediaan Kantor Pusat PT MRT Jakarta": {
        formula: "Tersedianya kajian perpindahan kantor pusat.",
        items: [
            { kr: "KR1: Terlaksananya kegiatan pengadaan vendor konsultan design", target: 100, unit: "%", relativeWeight: 25 },
            { kr: "KR2: Tersedianya concept design fitout dan relayout WN dan TH", target: 100, unit: "%", relativeWeight: 25 },
            { kr: "KR3: Disetujuinya design fitout dan relayout", target: 100, unit: "%", relativeWeight: 25 },
            { kr: "KR4: Tersedianya laporan Space Planning", target: 100, unit: "%", relativeWeight: 25 }
        ]
    },
    "Optimasi Perjalanan Dinas Karyawan": {
        formula: "Development integrasi perjalanan dinas pada platform milik PT MRTJ.",
        items: [
            { kr: "KR1: Tersusun dan disetujuinya 1 Protokol Integrasi / Sinkronisasi Workflow", target: 1, unit: "Dokumen", relativeWeight: 40 },
            { kr: "KR2: 100% fitur utama (Pemesanan, Approval, Budgeting) berhasil dideploy", target: 100, unit: "%", relativeWeight: 40 },
            { kr: "KR3: 100% Dokumentasi project tercatat", target: 100, unit: "%", relativeWeight: 20 }
        ]
    },
    "Tingkat pemenuhan IDP": { formula: "Realisasi pemenuhan IDP", items: [{ kr: "Realisasi IDP (Skor Max 5)", target: 5, unit: "Skor", relativeWeight: 100 }] },
    "Indeks Knowledge Management": { formula: "Tercapainya Skor KM Index", items: [{ kr: "Skor KM (Target 4)", target: 4, unit: "Skor", relativeWeight: 100 }] },
    "Indeks GRC": { formula: "Terselesaikannya 100% pemenuhan GRC Direktorat", items: [{ kr: "Skor GRC (Target 100%)", target: 100, unit: "%", relativeWeight: 100 }] },
    "Penyelesaian Temuan Audit": { formula: "Terselesaikannya 100% temuan audit", items: [{ kr: "Penyelesaian Audit (Target 100%)", target: 100, unit: "%", relativeWeight: 100 }] }
};

const employeeWeights2026 = {
    "M. Ardhan Rafsanjani": { "Terlaksananya kegiatan budget controlling": 10, "Tercapainya success rate pengelolaan layanan umum": 10, "Indeks Kepuasan Stakeholder": 2.5, "Jumlah Inisiatif Peningkatan Proses atau Efisiensi": 10, "Petty Cash Handling": 10, "Tingkat Kepatuhan Prosedur Keselamatan": 10, "Pengelolaan Inventaris Aset Kantor": 10, "Tingkat Kesesuaian Rencana Pengadaan": 7.5, "Penyediaan Kantor Pusat PT MRT Jakarta": 10, "Optimasi Perjalanan Dinas Karyawan": 10, "Tingkat pemenuhan IDP": 2.5, "Indeks Knowledge Management": 2.5, "Indeks GRC": 2.5, "Penyelesaian Temuan Audit": 2.5 },
    "Maya Satih Kanteyan": { "Terlaksananya kegiatan budget controlling": 10, "Tercapainya success rate pengelolaan layanan umum": 10, "Indeks Kepuasan Stakeholder": 2.5, "Jumlah Inisiatif Peningkatan Proses atau Efisiensi": 10, "Petty Cash Handling": 10, "Tingkat Kepatuhan Prosedur Keselamatan": 10, "Pengelolaan Inventaris Aset Kantor": 10, "Tingkat Kesesuaian Rencana Pengadaan": 7.5, "Penyediaan Kantor Pusat PT MRT Jakarta": 10, "Optimasi Perjalanan Dinas Karyawan": 10, "Tingkat pemenuhan IDP": 2.5, "Indeks Knowledge Management": 2.5, "Indeks GRC": 2.5, "Penyelesaian Temuan Audit": 2.5 },
    "Waziruddin": { "Terlaksananya kegiatan budget controlling": 10, "Tercapainya success rate pengelolaan layanan umum": 10, "Indeks Kepuasan Stakeholder": 2.5, "Jumlah Inisiatif Peningkatan Proses atau Efisiensi": 10, "Petty Cash Handling": 10, "Tingkat Kepatuhan Prosedur Keselamatan": 10, "Pengelolaan Inventaris Aset Kantor": 10, "Tingkat Kesesuaian Rencana Pengadaan": 7.5, "Penyediaan Kantor Pusat PT MRT Jakarta": 10, "Optimasi Perjalanan Dinas Karyawan": 10, "Tingkat pemenuhan IDP": 2.5, "Indeks Knowledge Management": 2.5, "Indeks GRC": 2.5, "Penyelesaian Temuan Audit": 2.5 },
    "Rizki Aziz Radyantama": { "Terlaksananya kegiatan budget controlling": 10, "Tercapainya success rate pengelolaan layanan umum": 10, "Indeks Kepuasan Stakeholder": 2.5, "Jumlah Inisiatif Peningkatan Proses atau Efisiensi": 12.5, "Tingkat Kepatuhan Prosedur Keselamatan": 15, "Tingkat Kesesuaian Rencana Pengadaan": 10, "Penyediaan Kantor Pusat PT MRT Jakarta": 15, "Optimasi Perjalanan Dinas Karyawan": 15, "Tingkat pemenuhan IDP": 2.5, "Indeks Knowledge Management": 2.5, "Indeks GRC": 2.5, "Penyelesaian Temuan Audit": 2.5 },
    "Annisa Mayangsari": { "Terlaksananya kegiatan budget controlling": 10, "Tercapainya success rate pengelolaan layanan umum": 25, "Indeks Kepuasan Stakeholder": 2.5, "Jumlah Inisiatif Peningkatan Proses atau Efisiensi": 20, "Petty Cash Handling": 22.5, "Tingkat Kesesuaian Rencana Pengadaan": 10, "Tingkat pemenuhan IDP": 2.5, "Indeks Knowledge Management": 2.5, "Indeks GRC": 2.5, "Penyelesaian Temuan Audit": 2.5 },
    "Rakhmat": { "Tercapainya success rate pengelolaan layanan umum": 20, "Indeks Kepuasan Stakeholder": 2.5, "Jumlah Inisiatif Peningkatan Proses atau Efisiensi": 20, "Tingkat Kepatuhan Prosedur Keselamatan": 20, "Pengelolaan Inventaris Aset Kantor": 10, "Tingkat Kesesuaian Rencana Pengadaan": 7.5, "Penyediaan Kantor Pusat PT MRT Jakarta": 10, "Tingkat pemenuhan IDP": 2.5, "Indeks Knowledge Management": 2.5, "Indeks GRC": 2.5, "Penyelesaian Temuan Audit": 2.5 },
    "Agung Prasetyo Wicaksono": { "Tercapainya success rate pengelolaan layanan umum": 20, "Indeks Kepuasan Stakeholder": 2.5, "Jumlah Inisiatif Peningkatan Proses atau Efisiensi": 20, "Tingkat Kepatuhan Prosedur Keselamatan": 20, "Pengelolaan Inventaris Aset Kantor": 10, "Tingkat Kesesuaian Rencana Pengadaan": 7.5, "Penyediaan Kantor Pusat PT MRT Jakarta": 10, "Tingkat pemenuhan IDP": 2.5, "Indeks Knowledge Management": 2.5, "Indeks GRC": 2.5, "Penyelesaian Temuan Audit": 2.5 },
    "Siti Zahratus Solihat": { "Terlaksananya kegiatan budget controlling": 20, "Tercapainya success rate pengelolaan layanan umum": 15, "Indeks Kepuasan Stakeholder": 2.5, "Jumlah Inisiatif Peningkatan Proses atau Efisiensi": 15, "Petty Cash Handling": 20, "Tingkat Kesesuaian Rencana Pengadaan": 7.5, "Optimasi Perjalanan Dinas Karyawan": 10, "Tingkat pemenuhan IDP": 2.5, "Indeks Knowledge Management": 2.5, "Indeks GRC": 2.5, "Penyelesaian Temuan Audit": 2.5 },
    "Abdul Ajid": { "Tercapainya success rate pengelolaan layanan umum": 20, "Indeks Kepuasan Stakeholder": 2.5, "Jumlah Inisiatif Peningkatan Proses atau Efisiensi": 25, "Tingkat Kepatuhan Prosedur Keselamatan": 20, "Pengelolaan Inventaris Aset Kantor": 15, "Tingkat Kesesuaian Rencana Pengadaan": 7.5, "Tingkat pemenuhan IDP": 2.5, "Indeks Knowledge Management": 2.5, "Indeks GRC": 2.5, "Penyelesaian Temuan Audit": 2.5 },
    "Dharisa Inayah Ramadhan": { "Terlaksananya kegiatan budget controlling": 10, "Tercapainya success rate pengelolaan layanan umum": 25, "Indeks Kepuasan Stakeholder": 2.5, "Jumlah Inisiatif Peningkatan Proses atau Efisiensi": 20, "Petty Cash Handling": 22.5, "Tingkat Kesesuaian Rencana Pengadaan": 10, "Tingkat pemenuhan IDP": 2.5, "Indeks Knowledge Management": 2.5, "Indeks GRC": 2.5, "Penyelesaian Temuan Audit": 2.5 }
};

const directScoreObjectives = new Set(["Tingkat pemenuhan IDP", "Indeks Knowledge Management", "GRC Index", "Indeks Penyelesaian Audit", "Indeks Kepuasan Stakeholder"]);

// --- HELPERS ---
function execCmd(cmd) { document.execCommand(cmd, false, null); }
function computeSf(finalRatio){ if (finalRatio >= 1.199) return 120; if (finalRatio > 1.001) return 110; if (finalRatio >= 0.999) return 100; if (finalRatio >= 0.8) return 90; return 80; }

function routeTo(pageId) {
    document.querySelectorAll('.page').forEach(el => { el.classList.remove('active'); el.style.display = 'none'; });
    const landing = document.getElementById('pageLanding');
    const nav = document.getElementById('innerNav');
    const body = document.body;

    if (pageId === 'landing') {
        landing.classList.add('active');
        nav.classList.remove('show');
        body.classList.add('landing-active');
    } else {
        landing.classList.remove('active');
        const target = document.getElementById('page' + pageId.charAt(0).toUpperCase() + pageId.slice(1));
        if(target) { target.style.display = 'block'; setTimeout(() => target.classList.add('active'), 10); }
        nav.classList.add('show');
        body.classList.remove('landing-active');
    }
    window.scrollTo(0,0);
}

// --- WORKSHEET LOGIC ---
function ws_handleNameChange() {
    const name = document.getElementById("ws_nama").value;
    const emp = employees.find(e => e.name === name);
    if(emp) { document.getElementById("ws_nik").value = emp.nik; document.getElementById("ws_jabatan").value = emp.title; }
}
function ws_handleLocationChange() {
    const sel = document.getElementById("ws_lokasiSelect");
    const inp = document.getElementById("ws_lokasiInput");
    inp.style.display = sel.value === "Lainnya" ? "block" : "none";
}
function ws_addPhoto() {
    const div = document.createElement("div"); div.className = "input-group";
    div.innerHTML = `<input type="file" class="form-control ws_photo_input" accept="image/*"><button class="btn btn-outline-danger" onclick="this.parentElement.remove()">x</button>`;
    document.getElementById("ws_photoContainer").appendChild(div);
}
function ws_generate() {
    if(!document.getElementById("ws_nama").value || !document.getElementById("ws_judul").value || !document.getElementById("ws_tanggal").value) return alert("Lengkapi data wajib!");
    
    document.getElementById("wr_jenis").innerText = document.getElementById("ws_jenis").value;
    document.getElementById("wr_nama").innerText = document.getElementById("ws_nama").value;
    document.getElementById("wr_nik").innerText = document.getElementById("ws_nik").value;
    document.getElementById("wr_jabatan_display").innerText = document.getElementById("ws_jabatan").value;
    document.getElementById("wr_judul").innerText = document.getElementById("ws_judul").value;
    document.getElementById("wr_tanggal").innerText = document.getElementById("ws_tanggal").value;
    let loc = document.getElementById("ws_lokasiSelect").value;
    if(loc==="Lainnya") loc = document.getElementById("ws_lokasiInput").value;
    document.getElementById("wr_lokasi").innerText = loc;
    document.getElementById("wr_deskripsi").innerHTML = document.getElementById("ws_deskripsi").innerHTML;
    document.getElementById("wr_catatan").innerHTML = document.getElementById("ws_catatan").innerHTML;
    document.getElementById("wr_atasan_nama").innerText = document.getElementById("ws_nama_atasan").value;
    document.getElementById("wr_atasan_jabatan").innerText = document.getElementById("ws_jabatan_atasan").value;
    document.getElementById("wr_maker_nama").innerText = document.getElementById("ws_nama").value;
    document.getElementById("wr_maker_jabatan").innerText = document.getElementById("ws_jabatan").value;
    
    let photos = "";
    document.querySelectorAll(".ws_photo_input").forEach(inp => {
        if(inp.files[0]) photos += `<div class="col-md-6 col-6"><img src="${URL.createObjectURL(inp.files[0])}" class="img-fluid border rounded shadow-sm" style="max-height:400px; width:100%; object-fit:contain; background:#f8fafc;"></div>`;
    });
    document.getElementById("wr_photos").innerHTML = photos;
    routeTo('workSheetReport');
}

// --- KPI 2025 LOGIC (FIXED) ---
function single_handleNameChange() {
    const name = document.getElementById("s_nama").value;
    const emp = employees.find(e=>e.name===name);
    // Fix NIK issue: ensure ids s_nik & s_jabatan exist
    if (emp) {
        document.getElementById("s_nik").value = emp.nik;
        document.getElementById("s_jabatan").value = emp.title;
    }
    const kpiSel = document.getElementById("s_obj"); kpiSel.innerHTML = "<option value=''>-- Pilih --</option>";
    if(employeeWeights2025[name]) Object.keys(employeeWeights2025[name]).forEach(k => kpiSel.add(new Option(k, k)));
}
function single_renderKeyResults() {
    const kpiName = document.getElementById("s_obj").value;
    const data = kpiData2025[kpiName]; // Use restored 2025 data
    if(!data) { document.getElementById("single_dynamic").style.display="none"; return; }
    document.getElementById("single_dynamic").style.display="block";
    document.getElementById("s_formula").innerText = data.formula;
    let html = "";
    data.items.forEach((item, idx) => {
        html += `<div class="mb-3 border p-3 rounded bg-white shadow-sm"><h6 class="fw-bold text-primary">${item.kr}</h6><div class="d-flex gap-3 align-items-center mt-2"><div class="badge bg-light text-dark border px-3 py-2">Target: ${item.target} ${item.unit}</div><div class="input-group"><span class="input-group-text bg-white fw-bold">Realisasi</span><input type="number" class="form-control s_inp fw-bold" data-target="${item.target}" data-weight="${item.relativeWeight}" placeholder="0"></div></div></div>`;
    });
    document.getElementById("s_krContainer").innerHTML = html;
}
function single_calculate() {
    calculateReport('s_nama', 's_obj', 's_declare', 's_ttd', 's_inp', 's_buktiMain', 's_editor_main', 's_jabatan', kpiData2025);
}

// --- KPI 2026 LOGIC ---
function k26_handleNameChange() {
    const name = document.getElementById("k26_nama").value;
    const emp = employees.find(e=>e.name===name);
    document.getElementById("k26_nik").value = emp.nik;
    document.getElementById("k26_jabatan").value = emp.title;
    
    const kpiSel = document.getElementById("k26_obj"); 
    kpiSel.innerHTML = "<option value=''>-- Pilih Item KPI 2026 --</option>";
    const userWeights = employeeWeights2026[name];
    if (userWeights) {
        Object.keys(userWeights).forEach(k => { if (kpiData2026[k]) kpiSel.add(new Option(k, k)); });
    }
}

function k26_renderKeyResults() {
    const kpiName = document.getElementById("k26_obj").value;
    const data = kpiData2026[kpiName];
    if(!data) { document.getElementById("k26_dynamic").style.display="none"; return; }
    document.getElementById("k26_dynamic").style.display="block";
    document.getElementById("k26_formula").innerText = data.formula;
    let html = "";
    data.items.forEach((item) => {
        html += `<div class="mb-3 border p-3 rounded bg-white shadow-sm"><h6 class="fw-bold text-dark">${item.kr} <span class="badge bg-warning text-dark">Bobot KR: ${item.relativeWeight}%</span></h6><div class="d-flex gap-3 align-items-center mt-2"><div class="badge bg-light text-dark border px-3 py-2">Target: ${item.target} ${item.unit}</div><div class="input-group"><span class="input-group-text bg-white fw-bold">Realisasi</span><input type="number" class="form-control k26_inp fw-bold" data-target="${item.target}" data-weight="${item.relativeWeight}" placeholder="0"></div></div></div>`;
    });
    document.getElementById("k26_krContainer").innerHTML = html;
}

function k26_addExtraEvidence() {
    const div = document.createElement('div');
    div.className = "mb-2 p-2 border rounded bg-white";
    div.innerHTML = `<input type="file" class="form-control mb-1 k26_extra_file"><input type="text" class="form-control form-control-sm" placeholder="Keterangan...">`;
    document.getElementById('k26_extraWrap').appendChild(div);
}

function k26_calculate() {
    calculateReport('k26_nama', 'k26_obj', 'k26_declare', 'k26_ttd', 'k26_inp', 'k26_buktiMain', 'k26_editor_main', 'k26_jabatan', kpiData2026, 'k26_extra_file');
}

// GENERIC CALCULATE FUNCTION
function calculateReport(idName, idObj, idDeclare, idTtd, classInp, idBukti, idEditor, idJabatan, dataSource, classExtraFile = null) {
    if(!document.getElementById(idDeclare).checked) return alert("Wajib centang pernyataan!");
    if(!document.getElementById(idTtd).files[0]) return alert("Wajib upload TTD!");

    const inputs = document.querySelectorAll('.' + classInp);
    let totalScore = 0; let totalBobot = 0; let rows = "";
    let allFilled = true;
    inputs.forEach(inp => { if(!inp.value) allFilled = false; });
    if(!allFilled) return alert("Isi semua realisasi!");

    const empName = document.getElementById(idName).value;
    const kpiName = document.getElementById(idObj).value;
    
    inputs.forEach(inp => {
        let target = parseFloat(inp.dataset.target);
        let weightKR = parseFloat(inp.dataset.weight);
        let real = parseFloat(inp.value);
        let scorePart = 0;
        if (target === 0) { scorePart = (real === 0) ? weightKR : 0; } 
        else { scorePart = (real / target) * weightKR; }
        totalScore += scorePart; totalBobot += weightKR;
        rows += `<tr><td class="text-start">${inp.parentElement.parentElement.previousElementSibling.innerText.split('Bobot')[0]}</td><td>${target}</td><td>${real}</td><td>${weightKR}%</td><td class="fw-bold">${scorePart.toFixed(2)}</td></tr>`;
    });

    let finalSF = computeSf(totalScore / 100); 
    if (directScoreObjectives.has(kpiName)) finalSF = parseFloat(inputs[0].value);
    else finalSF = computeSf(totalScore/100); 

    document.getElementById("sr_nama").innerText = empName;
    document.getElementById("sr_jabatan_kpi").innerText = document.getElementById(idJabatan).value;
    document.getElementById("sr_obj").innerText = kpiName;
    document.getElementById("sr_rows").innerHTML = rows;
    document.getElementById("sr_totalBobot").innerText = totalBobot + "%";
    document.getElementById("sr_totalScore").innerText = totalScore.toFixed(2);
    document.getElementById("sr_sf").innerText = finalSF;

    const img = document.getElementById(idBukti).files[0];
    let htmlEvi = `<img src="${URL.createObjectURL(img)}" class="img-fluid border rounded" style="max-height:400px;"><div class="mt-2 p-2 bg-white border small">${document.getElementById(idEditor).innerHTML}</div>`;
    if(classExtraFile) {
        document.querySelectorAll('.'+classExtraFile).forEach(f => {
            if(f.files[0]) htmlEvi += `<div class="mt-2"><img src="${URL.createObjectURL(f.files[0])}" class="img-fluid border" style="max-height:200px;"></div>`;
        });
    }
    document.getElementById("sr_evi").innerHTML = htmlEvi;

    const ttd = document.getElementById(idTtd).files[0];
    document.getElementById("sr_ttdImg").src = URL.createObjectURL(ttd);
    document.getElementById("sr_sigNama").innerText = empName;
    document.getElementById("sr_sigJabatan").innerText = document.getElementById(idJabatan).value;
    
    const d = new Date(); document.getElementById("sr_date").innerText = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
    routeTo('singleReport');
}

// --- INIT ---
window.onload = function() {
    const selects = ["s_nama", "k26_nama", "ws_nama"];
    selects.forEach(id => {
        const el = document.getElementById(id);
        if(el) employees.forEach(e => el.add(new Option(e.name, e.name)));
    });
    routeTo('landing');
};
</script>
</body>
</html>